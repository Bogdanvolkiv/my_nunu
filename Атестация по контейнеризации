#!/bin/bash

echo "üîß –°–æ–∑–¥–∞—ë–º –ø—Ä–æ–µ–∫—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏..."

# === 1. –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π ===
mkdir -p project/{dev,lab,app}
cd project

# === 2. –°–æ–∑–¥–∞—ë–º Python-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ===
cat <<EOF > app/app.py
from flask import Flask
import os
import psycopg2

app = Flask(__name__)

@app.route("/")
def hello():
    db_host = os.environ.get("DB_HOST", "localhost")
    return f"–ü—Ä–∏–≤–µ—Ç –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è! DB_HOST = {db_host}"

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
EOF

# === 3. Dockerfile –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
cat <<EOF > app/Dockerfile
FROM python:3.10-slim

WORKDIR /app
COPY app.py .

RUN pip install flask psycopg2-binary

CMD ["python", "app.py"]
EOF

# === 4. docker-compose.yml –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏—è DEV ===
cat <<EOF > dev/docker-compose.yml
version: '3.8'

services:
  web:
    build: ../app
    ports:
      - "5000:5000"
    environment:
      - DB_HOST=db
    depends_on:
      - db

  db:
    image: postgres:13
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=mydb

volumes:
  pgdata:
EOF

# === 5. docker-compose.yml –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏—è LAB ===
cat <<EOF > lab/docker-compose.yml
version: '3.8'

services:
  web:
    build: ../app
    ports:
      - "5050:5000"
    environment:
      - DB_HOST=db
    depends_on:
      - db

  db:
    image: postgres:13
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=mydb

volumes:
  pgdata:
EOF

# === 6. –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –æ–∫—Ä—É–∂–µ–Ω–∏–π ===
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏—è dev –∏ lab..."

cd dev && docker-compose up -d
cd ../lab && docker-compose up -d

# === 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ===
echo "üì¶ –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

echo "‚úÖ –í—Å—ë –≥–æ—Ç–æ–≤–æ. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞:"
echo " - http://localhost:5000 (dev)"
echo " - http://localhost:5050 (lab)"
